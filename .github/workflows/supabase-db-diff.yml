name: supabase-db-diff
on: { workflow_dispatch: {} }
permissions:
  contents: write
  pull-requests: write
env:
  SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}

jobs:
  diff:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Validate secret
        run: |
          if [ -z "${SUPABASE_DB_URL}" ]; then
            echo "ERR: SUPABASE_DB_URL empty"
            exit 1
          fi

      - name: Create migration diff
        run: |
          STAMP=$(date -u +%Y%m%d%H%M%S)
          pnpm dlx supabase@latest db diff \
            --db-url "${SUPABASE_DB_URL}" \
            --schema public \
            -f "supabase/migrations/${STAMP}_auto.sql" || true

      - name: Generate TypeScript DB types
        run: |
          mkdir -p src/lib
          pnpm dlx supabase@latest gen types typescript \
            --db-url "${SUPABASE_DB_URL}" \
            -s public -s auth -s storage > src/lib/database.types.ts

      - name: Create PR if changed
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(db): auto diff + typegen"
          title: "chore(db): auto diff + typegen"
          branch: chore/db-diff
          add-paths: |
            supabase/migrations/**
            src/lib/database.types.ts
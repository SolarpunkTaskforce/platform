name: supabase-db-diff
on: { workflow_dispatch: {} }
permissions:
  contents: write
  pull-requests: write
env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }} # needed for --project-id typegen
  SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
  SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

jobs:
  diff:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with: { version: 10 }

      - name: Build DB URL
        id: db
        run: echo "url=postgres://postgres:${SUPABASE_DB_PASSWORD}@db.${SUPABASE_PROJECT_REF}.supabase.co:5432/postgres" >> "$GITHUB_OUTPUT"

      - name: Create migration diff
        run: |
          STAMP=$(date -u +%Y%m%d%H%M%S)
          pnpm dlx supabase@latest db diff \
            --db-url "${{ steps.db.outputs.url }}" \
            --schema public \
            -f "supabase/migrations/${STAMP}_auto.sql" || true

      - name: Generate TypeScript DB types
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          mkdir -p src/lib
          pnpm dlx supabase@latest gen types typescript \
            --project-id "$SUPABASE_PROJECT_REF" \
            -s public -s auth -s storage > src/lib/database.types.ts

      - name: Create PR if changed
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(db): auto diff + typegen"
          title: "chore(db): auto diff + typegen"
          branch: chore/db-diff
          add-paths: |
            supabase/migrations/**
            src/lib/database.types.ts